<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç† - Suna Study System</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/payment.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>ğŸ“š Suna Study System</h1>
                </div>
                <nav class="nav">
                    <a href="../pages/admin.html" class="nav-link">ç®¡ç†ç”»é¢</a>
                    <a href="pricing.html" class="nav-link">æ–™é‡‘ãƒ—ãƒ©ãƒ³</a>
                    <button class="btn-secondary logout-required" onclick="supabaseAuth.signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="page-header">
                <h2>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†</h2>
                <p>ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³çŠ¶æ³ã¨æ±ºæ¸ˆæƒ…å ±ã‚’ç®¡ç†ã§ãã¾ã™</p>
            </div>

            <!-- ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ³ -->
            <div id="subscription-status" class="subscription-status-container">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- ä½¿ç”¨é‡è©³ç´° -->
            <div id="usage-details" class="usage-details-section" style="display: none;">
                <h3>ä½¿ç”¨é‡è©³ç´°</h3>
                <div class="usage-grid">
                    <div class="usage-card">
                        <div class="usage-icon">ğŸ‘¥</div>
                        <div class="usage-info">
                            <h4>ç”Ÿå¾’æ•°</h4>
                            <div class="usage-numbers">
                                <span id="current-students">0</span> / <span id="max-students">0</span>
                            </div>
                            <div class="usage-bar">
                                <div id="students-progress" class="usage-fill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="usage-card">
                        <div class="usage-icon">ğŸ“š</div>
                        <div class="usage-info">
                            <h4>ã‚³ãƒ¼ã‚¹æ•°</h4>
                            <div class="usage-numbers">
                                <span id="current-courses">0</span> / <span id="max-courses">0</span>
                            </div>
                            <div class="usage-bar">
                                <div id="courses-progress" class="usage-fill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="usage-card">
                        <div class="usage-icon">ğŸ“Š</div>
                        <div class="usage-info">
                            <h4>ä»Šæœˆã®æ´»å‹•</h4>
                            <div class="activity-stats">
                                <p>ãƒ­ã‚°ã‚¤ãƒ³æ•°: <span id="monthly-logins">-</span></p>
                                <p>è¦–è´æ™‚é–“: <span id="monthly-watch-time">-</span>h</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ±ºæ¸ˆæƒ…å ± -->
            <div id="billing-section" class="billing-section" style="display: none;">
                <h3>æ±ºæ¸ˆæƒ…å ±</h3>
                <div class="billing-content">
                    <div class="payment-method-section">
                        <h4>æ±ºæ¸ˆæ–¹æ³•</h4>
                        <div id="payment-methods" class="payment-methods-list">
                            <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                        <button class="btn-secondary" onclick="showAddPaymentMethodModal()">
                            æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ 
                        </button>
                    </div>
                    
                    <div class="billing-address-section">
                        <h4>è«‹æ±‚å…ˆä½æ‰€</h4>
                        <div id="billing-address" class="billing-address-info">
                            <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                        <button class="btn-secondary" onclick="showEditBillingAddressModal()">
                            è«‹æ±‚å…ˆä½æ‰€ã‚’ç·¨é›†
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ±ºæ¸ˆå±¥æ­´ -->
            <div class="payment-history-section">
                <div class="section-header">
                    <h3>æ±ºæ¸ˆå±¥æ­´</h3>
                    <div class="history-controls">
                        <select id="history-filter" onchange="filterPaymentHistory()">
                            <option value="all">ã™ã¹ã¦</option>
                            <option value="succeeded">æˆåŠŸ</option>
                            <option value="failed">å¤±æ•—</option>
                            <option value="pending">å‡¦ç†ä¸­</option>
                        </select>
                        <button class="btn-secondary" onclick="exportPaymentHistory()">
                            CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
                
                <div id="payment-history-container" class="payment-history-container">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>æ±ºæ¸ˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
                
                <div id="history-pagination" class="pagination-container" style="display: none;"></div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="subscription-actions" class="subscription-actions-section" style="display: none;">
                <h3>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <div class="actions-grid">
                    <div class="action-card">
                        <h4>ãƒ—ãƒ©ãƒ³å¤‰æ›´</h4>
                        <p>ã‚ˆã‚Šå¤šãã®æ©Ÿèƒ½ã‚„å®¹é‡ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                        <button class="btn-primary" onclick="window.location.href='pricing.html'">
                            ãƒ—ãƒ©ãƒ³ã‚’å¤‰æ›´
                        </button>
                    </div>
                    
                    <div class="action-card">
                        <h4>è«‹æ±‚æ›¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h4>
                        <p>éå»ã®è«‹æ±‚æ›¸ã‚’PDFå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                        <button class="btn-secondary" onclick="showInvoiceList()">
                            è«‹æ±‚æ›¸ä¸€è¦§
                        </button>
                    </div>
                    
                    <div class="action-card danger">
                        <h4>ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«</h4>
                        <p>ã‚µãƒ¼ãƒ“ã‚¹ãŒä¸è¦ã«ãªã£ãŸå ´åˆã¯ã€ã„ã¤ã§ã‚‚ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ãã¾ã™ã€‚</p>
                        <button class="btn-danger" onclick="showCancelDialog()">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal-container"></div>

    <!-- é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  -->
    <div id="notification-container" class="notification-container"></div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Suna Study System. All rights reserved.</p>
            <div class="footer-links">
                <a href="#" class="footer-link">åˆ©ç”¨è¦ç´„</a>
                <a href="#" class="footer-link">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                <a href="#" class="footer-link">ãŠå•ã„åˆã‚ã›</a>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/payment.js"></script>
    
    <script>
        let currentPage = 1;
        let currentFilter = 'all';
        let paymentHistoryData = null;

        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const user = supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadSubscriptionData();
            await loadPaymentHistory();
        });

        async function loadSubscriptionData() {
            try {
                const userProfile = await getCurrentUserProfile();
                if (!userProfile || !userProfile.schools) {
                    showNoSubscriptionMessage();
                    return;
                }

                const response = await fetch(`/api/subscription-status/${userProfile.schools.id}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                if (!data.hasSubscription) {
                    showNoSubscriptionMessage();
                    return;
                }

                renderSubscriptionStatus(data);
                renderUsageDetails(data.usage);
                
                document.getElementById('billing-section').style.display = 'block';
                document.getElementById('subscription-actions').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading subscription data:', error);
                showError('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function showNoSubscriptionMessage() {
            const container = document.getElementById('subscription-status');
            container.innerHTML = `
                <div class="no-subscription">
                    <div class="no-subscription-icon">ğŸ’³</div>
                    <h3>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                    <p>Suna Study Systemã‚’ã”åˆ©ç”¨ã„ãŸã ãã«ã¯ã€ãƒ—ãƒ©ãƒ³ã®é¸æŠãŒå¿…è¦ã§ã™ã€‚</p>
                    <div class="no-subscription-actions">
                        <a href="pricing.html" class="btn-primary">ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã™ã‚‹</a>
                        <a href="../pages/admin.html" class="btn-secondary">ç®¡ç†ç”»é¢ã«æˆ»ã‚‹</a>
                    </div>
                </div>
            `;
        }

        function renderSubscriptionStatus(data) {
            const subscription = data.subscription;
            const plan = subscription.pricing_plans;
            
            const container = document.getElementById('subscription-status');
            container.innerHTML = `
                <div class="subscription-active">
                    <div class="subscription-header">
                        <div class="plan-info">
                            <h3>${plan.name}</h3>
                            <p>${plan.description}</p>
                        </div>
                        <div class="status-info">
                            <span class="status-badge status-${subscription.status}">
                                ${getStatusText(subscription.status)}
                            </span>
                        </div>
                    </div>
                    
                    <div class="subscription-details">
                        <div class="detail-item">
                            <span class="detail-label">æ–™é‡‘</span>
                            <span class="detail-value">
                                Â¥${(subscription.billing_cycle === 'yearly' ? plan.price_yearly : plan.price_monthly).toLocaleString()}
                                /${subscription.billing_cycle === 'yearly' ? 'å¹´' : 'æœˆ'}
                            </span>
                        </div>
                        
                        <div class="detail-item">
                            <span class="detail-label">æ¬¡å›è«‹æ±‚æ—¥</span>
                            <span class="detail-value">
                                ${new Date(subscription.current_period_end).toLocaleDateString('ja-JP')}
                            </span>
                        </div>
                        
                        ${subscription.trial_end ? `
                            <div class="detail-item">
                                <span class="detail-label">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«çµ‚äº†æ—¥</span>
                                <span class="detail-value">
                                    ${new Date(subscription.trial_end).toLocaleDateString('ja-JP')}
                                </span>
                            </div>
                        ` : ''}
                        
                        ${subscription.canceled_at ? `
                            <div class="detail-item">
                                <span class="detail-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥</span>
                                <span class="detail-value">
                                    ${new Date(subscription.canceled_at).toLocaleDateString('ja-JP')}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderUsageDetails(usage) {
            if (!usage) return;

            document.getElementById('usage-details').style.display = 'block';
            
            const studentsPercent = usage.max_students ? (usage.current_students / usage.max_students * 100) : 50;
            const coursesPercent = usage.max_courses ? (usage.current_courses / usage.max_courses * 100) : 50;
            
            document.getElementById('current-students').textContent = usage.current_students;
            document.getElementById('max-students').textContent = usage.max_students || 'ç„¡åˆ¶é™';
            document.getElementById('current-courses').textContent = usage.current_courses;
            document.getElementById('max-courses').textContent = usage.max_courses || 'ç„¡åˆ¶é™';
            
            document.getElementById('students-progress').style.width = `${studentsPercent}%`;
            document.getElementById('courses-progress').style.width = `${coursesPercent}%`;
        }

        async function loadPaymentHistory() {
            try {
                const userProfile = await getCurrentUserProfile();
                if (!userProfile || !userProfile.schools) return;

                const response = await fetch(`/api/payment-history/${userProfile.schools.id}?page=${currentPage}&filter=${currentFilter}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error);
                }

                paymentHistoryData = data;
                renderPaymentHistory(data);
                renderPagination(data);
                
            } catch (error) {
                console.error('Error loading payment history:', error);
                showError('æ±ºæ¸ˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function renderPaymentHistory(data) {
            const container = document.getElementById('payment-history-container');
            
            if (data.payments.length === 0) {
                container.innerHTML = `
                    <div class="no-payments">
                        <p>æ±ºæ¸ˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="payment-history-table">
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>é‡‘é¡</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ±ºæ¸ˆæ–¹æ³•</th>
                                <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.payments.map(payment => `
                                <tr>
                                    <td>${new Date(payment.created_at).toLocaleDateString('ja-JP')}</td>
                                    <td>Â¥${payment.amount.toLocaleString()}</td>
                                    <td>
                                        <span class="status-badge status-${payment.status}">
                                            ${getPaymentStatusText(payment.status)}
                                        </span>
                                    </td>
                                    <td>${payment.payment_method || '-'}</td>
                                    <td>
                                        ${payment.receipt_url ? `
                                            <a href="${payment.receipt_url}" target="_blank" class="btn-link">
                                                é ˜åæ›¸
                                            </a>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPagination(data) {
            const container = document.getElementById('history-pagination');
            
            if (data.totalPages <= 1) {
                container.style.display = 'none';
                return;
            }

            let paginationHTML = '<div class="pagination">';
            
            // Previous button
            if (data.page > 1) {
                paginationHTML += `<button class="btn-pagination" onclick="changePage(${data.page - 1})">å‰ã¸</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= data.totalPages; i++) {
                if (i === data.page) {
                    paginationHTML += `<button class="btn-pagination active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="btn-pagination" onclick="changePage(${i})">${i}</button>`;
                }
            }
            
            // Next button
            if (data.page < data.totalPages) {
                paginationHTML += `<button class="btn-pagination" onclick="changePage(${data.page + 1})">æ¬¡ã¸</button>`;
            }
            
            paginationHTML += '</div>';
            container.innerHTML = paginationHTML;
            container.style.display = 'block';
        }

        async function changePage(page) {
            currentPage = page;
            await loadPaymentHistory();
        }

        async function filterPaymentHistory() {
            const filter = document.getElementById('history-filter').value;
            currentFilter = filter;
            currentPage = 1;
            await loadPaymentHistory();
        }

        function showCancelDialog() {
            if (paymentManager) {
                paymentManager.showCancelDialog();
            }
        }

        function showInvoiceList() {
            // è«‹æ±‚æ›¸ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            console.log('Show invoice list');
        }

        function exportPaymentHistory() {
            if (!paymentHistoryData || !paymentHistoryData.payments.length) {
                showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const csvContent = generateCSV(paymentHistoryData.payments);
            downloadCSV(csvContent, `payment_history_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function generateCSV(payments) {
            const headers = ['æ—¥ä»˜', 'é‡‘é¡', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'æ±ºæ¸ˆæ–¹æ³•', 'èª¬æ˜'];
            const rows = payments.map(payment => [
                new Date(payment.created_at).toLocaleDateString('ja-JP'),
                payment.amount,
                getPaymentStatusText(payment.status),
                payment.payment_method || '',
                payment.description || ''
            ]);

            return [headers, ...rows].map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getStatusText(status) {
            const statusMap = {
                'trialing': 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­',
                'active': 'æœ‰åŠ¹',
                'past_due': 'æ”¯æ‰•ã„æœŸé™è¶…é',
                'canceled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿',
                'unpaid': 'æœªæ‰•ã„'
            };
            return statusMap[status] || status;
        }

        function getPaymentStatusText(status) {
            const statusMap = {
                'pending': 'å‡¦ç†ä¸­',
                'succeeded': 'æˆåŠŸ',
                'failed': 'å¤±æ•—',
                'canceled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                'refunded': 'è¿”é‡‘æ¸ˆã¿'
            };
            return statusMap[status] || status;
        }

        function showError(message) {
            console.error(message);
            // å®Ÿéš›ã«ã¯ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…
            alert(message);
        }
    </script>
</body>
</html>