<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–™é‡‘ãƒ—ãƒ©ãƒ³é¸æŠ - Suna Study System</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/payment.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>ğŸ“š Suna Study System</h1>
                </div>
                <nav class="nav">
                    <a href="../pages/admin.html" class="nav-link">ç®¡ç†ç”»é¢</a>
                    <a href="subscription.html" class="nav-link">ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†</a>
                    <button class="btn-secondary logout-required" onclick="supabaseAuth.signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="page-header">
                <h2>æ–™é‡‘ãƒ—ãƒ©ãƒ³é¸æŠ</h2>
                <p>ã‚ãªãŸã®å¡¾ã«æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ãŠé¸ã³ãã ã•ã„ã€‚ã™ã¹ã¦ã®ãƒ—ãƒ©ãƒ³ã§14æ—¥é–“ã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
            </div>

            <!-- ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ³ -->
            <div id="current-subscription" class="current-subscription" style="display: none;">
                <div class="subscription-alert">
                    <h3>ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³</h3>
                    <div id="subscription-info"></div>
                </div>
            </div>

            <!-- æ–™é‡‘ãƒ—ãƒ©ãƒ³ -->
            <div class="pricing-section">
                <div class="pricing-header">
                    <h3>ãƒ—ãƒ©ãƒ³ä¸€è¦§</h3>
                    <div class="billing-toggle">
                        <label class="toggle-label">
                            <input type="radio" name="billing-display" value="monthly" checked>
                            <span>æœˆé¡è¡¨ç¤º</span>
                        </label>
                        <label class="toggle-label">
                            <input type="radio" name="billing-display" value="yearly">
                            <span>å¹´é¡è¡¨ç¤º</span>
                        </label>
                    </div>
                </div>

                <div id="pricing-plans-container" class="pricing-plans">
                    <!-- æ–™é‡‘ãƒ—ãƒ©ãƒ³ãŒJavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>ãƒ—ãƒ©ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ©ãƒ³æ¯”è¼ƒè¡¨ -->
            <div class="comparison-section">
                <h3>ãƒ—ãƒ©ãƒ³æ¯”è¼ƒ</h3>
                <div class="comparison-table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>æ©Ÿèƒ½</th>
                                <th>ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³</th>
                                <th>ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³</th>
                                <th>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³</th>
                                <th>ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚º</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>æœ€å¤§ç”Ÿå¾’æ•°</td>
                                <td>20å</td>
                                <td>100å</td>
                                <td>500å</td>
                                <td>ç„¡åˆ¶é™</td>
                            </tr>
                            <tr>
                                <td>æœ€å¤§ã‚³ãƒ¼ã‚¹æ•°</td>
                                <td>10ã‚³ãƒ¼ã‚¹</td>
                                <td>50ã‚³ãƒ¼ã‚¹</td>
                                <td>ç„¡åˆ¶é™</td>
                                <td>ç„¡åˆ¶é™</td>
                            </tr>
                            <tr>
                                <td>5ç§‘ç›®å¯¾å¿œ</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>å­¦ç¿’é€²æ—ç®¡ç†</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>è©³ç´°ãªåˆ†ææ©Ÿèƒ½</td>
                                <td>âŒ</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½</td>
                                <td>âŒ</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>API ã‚¢ã‚¯ã‚»ã‚¹</td>
                                <td>âŒ</td>
                                <td>âŒ</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>ç™½ãƒ©ãƒ™ãƒ«å¯¾å¿œ</td>
                                <td>âŒ</td>
                                <td>âŒ</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>å°‚ç”¨ã‚µãƒãƒ¼ãƒˆ</td>
                                <td>âŒ</td>
                                <td>âŒ</td>
                                <td>âœ…</td>
                                <td>âœ…</td>
                            </tr>
                            <tr>
                                <td>å°å…¥ã‚³ãƒ³ã‚µãƒ«ãƒ†ã‚£ãƒ³ã‚°</td>
                                <td>âŒ</td>
                                <td>âŒ</td>
                                <td>âŒ</td>
                                <td>âœ…</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ã‚ˆãã‚ã‚‹è³ªå• -->
            <div class="faq-section">
                <h3>ã‚ˆãã‚ã‚‹è³ªå•</h3>
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question">ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­ã«æ–™é‡‘ã¯ç™ºç”Ÿã—ã¾ã™ã‹ï¼Ÿ</div>
                        <div class="faq-answer">
                            ã„ã„ãˆã€14æ—¥é–“ã®ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“ä¸­ã¯ä¸€åˆ‡æ–™é‡‘ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚ãƒˆãƒ©ã‚¤ã‚¢ãƒ«æœŸé–“çµ‚äº†å‰ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">ãƒ—ãƒ©ãƒ³ã®å¤‰æ›´ã¯ã§ãã¾ã™ã‹ï¼Ÿ</div>
                        <div class="faq-answer">
                            ã¯ã„ã€ã„ã¤ã§ã‚‚ãƒ—ãƒ©ãƒ³ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚„ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¯èƒ½ã§ã™ã€‚å¤‰æ›´ã¯æ¬¡å›è«‹æ±‚æ—¥ã‹ã‚‰é©ç”¨ã•ã‚Œã¾ã™ã€‚
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ã§ãã¾ã™ã‹ï¼Ÿ</div>
                        <div class="faq-answer">
                            ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ä»¥ä¸Šã§ã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚„é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">ã‚µãƒãƒ¼ãƒˆä½“åˆ¶ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</div>
                        <div class="faq-answer">
                            ã‚¹ã‚¿ãƒ¼ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³ã¯åŸºæœ¬ã‚µãƒãƒ¼ãƒˆï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰ã€ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ—ãƒ©ãƒ³ã¯å„ªå…ˆã‚µãƒãƒ¼ãƒˆã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»¥ä¸Šã¯å°‚ç”¨ã‚µãƒãƒ¼ãƒˆã‚’ã”æä¾›ã—ã¾ã™ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ±ºæ¸ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="payment-modal" class="modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-content" id="payment-modal-content">
            <!-- æ±ºæ¸ˆãƒ•ã‚©ãƒ¼ãƒ ãŒJavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  -->
    <div id="notification-container" class="notification-container"></div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Suna Study System. All rights reserved.</p>
            <div class="footer-links">
                <a href="#" class="footer-link">åˆ©ç”¨è¦ç´„</a>
                <a href="#" class="footer-link">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
                <a href="#" class="footer-link">ãŠå•ã„åˆã‚ã›</a>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="../js/supabase-config.js"></script>
    <script src="../js/payment.js"></script>
    
    <script>
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const user = supabaseClient.auth.getUser();
            if (!user) {
                window.location.href = '../login.html';
                return;
            }

            // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã®å‡¦ç†
            document.querySelectorAll('input[name="billing-display"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updatePricingDisplay(e.target.value);
                });
            });

            // FAQ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³
            document.querySelectorAll('.faq-question').forEach(question => {
                question.addEventListener('click', () => {
                    const faqItem = question.parentElement;
                    faqItem.classList.toggle('active');
                });
            });

            // ç¾åœ¨ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
            await displayCurrentSubscription();
        });

        function updatePricingDisplay(billingType) {
            // æ–™é‡‘è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†
            document.querySelectorAll('.pricing-card').forEach(card => {
                const monthlyPrice = card.querySelector('.price-monthly');
                const yearlyPrice = card.querySelector('.price-yearly');
                
                if (billingType === 'yearly') {
                    monthlyPrice.style.display = 'none';
                    if (yearlyPrice) yearlyPrice.style.display = 'block';
                } else {
                    monthlyPrice.style.display = 'block';
                    if (yearlyPrice) yearlyPrice.style.display = 'none';
                }
            });
        }

        async function displayCurrentSubscription() {
            try {
                const userProfile = await getCurrentUserProfile();
                if (!userProfile || !userProfile.schools) return;

                const response = await fetch(`/api/subscription-status/${userProfile.schools.id}`);
                const data = await response.json();

                if (data.hasSubscription) {
                    const container = document.getElementById('current-subscription');
                    const info = document.getElementById('subscription-info');
                    
                    const subscription = data.subscription;
                    const plan = subscription.pricing_plans;
                    
                    info.innerHTML = `
                        <div class="current-plan-info">
                            <p><strong>ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³:</strong> ${plan.name}</p>
                            <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span class="status-badge status-${subscription.status}">${getStatusText(subscription.status)}</span></p>
                            <p><strong>æ¬¡å›è«‹æ±‚æ—¥:</strong> ${new Date(subscription.current_period_end).toLocaleDateString('ja-JP')}</p>
                            <a href="subscription.html" class="btn-primary">è©³ç´°ã‚’è¦‹ã‚‹</a>
                        </div>
                    `;
                    
                    container.style.display = 'block';
                }
            } catch (error) {
                console.error('Error displaying current subscription:', error);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'trialing': 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ä¸­',
                'active': 'æœ‰åŠ¹',
                'past_due': 'æ”¯æ‰•ã„æœŸé™è¶…é',
                'canceled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿',
                'unpaid': 'æœªæ‰•ã„'
            };
            return statusMap[status] || status;
        }
    </script>
</body>
</html>